# Story 4.3: 30-Day Old Data Cleanup

## Status

Done

## Story

**As a** 시스템 관리자,
**I want** 30일 이상 경과한 스크린샷과 JSON 결과를 자동으로 삭제하기를 원합니다,
**so that** 스토리지를 효율적으로 관리할 수 있습니다.

## Acceptance Criteria

1. 매 실행 시작 시 30일 이상 경과한 폴더를 검색한다
2. 해당 폴더의 모든 파일을 삭제한다
3. 삭제된 폴더 개수와 파일 개수를 로그에 기록한다
4. 삭제 실패 시 에러 로그를 기록하지만 검증은 계속 진행한다
5. 현재 날짜 폴더는 30일 경과 여부와 무관하게 삭제하지 않는다

## Tasks / Subtasks

- [x] Implement folder age detection (AC: 1, 5)
  - [x] Create `cleanupOldFiles()` function in `resultStorage` module
  - [x] Read folders from `results/` and `screenshots/`
  - [x] Parse folder names as dates (YYYY-MM-DD)
  - [x] Calculate age (current date - folder date)
  - [x] Filter folders older than retention period

- [x] Implement file deletion (AC: 2)
  - [x] For each old folder, delete recursively
  - [x] Use `fs.promises.rm(path, { recursive: true })`
  - [x] Count files before deletion

- [x] Add logging (AC: 3, 4)
  - [x] Log each folder deletion
  - [x] Log total folders and files deleted
  - [x] Log errors but don't throw

- [x] Add configuration
  - [x] Use environment variable `RETENTION_DAYS` (default: 30)
  - [x] Allow customization per deployment

## Dev Notes

**Module**: `resultStorage`
**Function**: `cleanupOldFiles(basePath, retentionDays)`
**Default Retention**: 30 days (env var `RETENTION_DAYS`)
**Target Folders**: `results/` and `screenshots/`

**Implementation** (see Epic 4 for full code)

**Cleanup Targets**:
- `results/YYYY-MM-DD/` folders > 30 days old
- `screenshots/YYYY-MM-DD/` folders > 30 days old

**Storage Estimates**:
- 100 properties × 2MB screenshot = 200MB/day
- 100 properties × 10KB JSON = 1MB/day
- 30-day retention = ~6GB total

**Integration Points**:
- Called by: `orchestrator` at start of execution
- Runs before: Property validation begins
- Independent: Does not affect validation

### Testing

**Test Location**: `test/modules/resultStorage.test.js`

**Testing Standards**:
- Test cleanup of old folders
- Test preservation of recent folders
- Test folder age calculation
- Test deletion counting
- Test error handling

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-29 | 1.0 | Initial story creation from Epic 4 | Sarah (PO) |
| 2025-01-29 | 1.1 | Story approved and ready for development | Sarah (PO) |
| 2025-01-29 | 1.2 | Tests created for resultStorage module covering Stories 4.1, 4.2, and 4.3. Implementation was already complete. | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No errors encountered during development. The `cleanupOldFiles` function was already implemented in `resultStorage.js`. Comprehensive test suite created successfully.

### Completion Notes List

1. **Module Already Implemented** (AC1-5):
   - `cleanupOldFiles()` function was already fully implemented in `src/modules/resultStorage.js` (lines 89-139)
   - Includes folder age detection, file deletion, logging, and error handling
   - Uses environment variable `RETENTION_DAYS` (default: 30 days)
   - Parses folder names as dates (YYYY-MM-DD) and calculates age
   - Logs deletion details and handles errors gracefully without throwing

2. **Comprehensive Test Suite Created**:
   - Created `test/modules/resultStorage.test.js` with comprehensive test coverage
   - Test groups:
     - **Result Storage - JSON Validation Result (Story 4.1)**: 4 tests for JSON saving
     - **Result Storage - Screenshot Capture (Story 4.2)**: 4 tests for fullpage screenshots
     - **Result Storage - Old Data Cleanup (Story 4.3)**: 10 tests for cleanup functionality
     - **Result Storage - Summary Save**: 1 test for execution summary
   - Total: 19 test cases covering all three stories (4.1, 4.2, 4.3)

3. **Story 4.3 Test Coverage** (AC1-5):
   - **AC1, AC2**: Folder age detection and deletion (3 tests)
   - **AC3**: Logging of deleted folders and files (1 test)
   - **AC4**: Error handling without throwing (1 test)
   - **AC5**: Current date folder protection (1 test)
   - Additional tests: Non-date folder handling, empty directory, custom retention period, missing directory (4 tests)

4. **Implementation Verification**:
   - Verified `cleanupOldFiles(basePath, retentionDays = 30)` function implementation
   - Confirmed date parsing logic with `new Date(folder)`
   - Validated age calculation and cutoff date filtering
   - Checked file counting and recursive deletion
   - Verified error logging without exception propagation

### File List

**Created Files**:
- `test/modules/resultStorage.test.js` - Comprehensive test suite (19 test cases covering Stories 4.1, 4.2, and 4.3)

**Existing Files** (Already Implemented):
- `src/modules/resultStorage.js` - Result storage module with `cleanupOldFiles()` function (172 lines)

## QA Results

(To be filled by QA agent)
