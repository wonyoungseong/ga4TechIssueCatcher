# Story 8.1: Web Server and REST API

## Status

Completed

## Story

**As a** 개발자,
**I want** Express.js 서버와 REST API를 구축하기를 원합니다,
**so that** 검증 결과를 웹에서 조회할 수 있습니다.

## Acceptance Criteria

1. ✅ Express.js 서버가 포트 3000에서 실행된다
2. ✅ REST API 엔드포인트가 구현된다 (결과 목록, 상세, 요약, 스크린샷)
3. ✅ CORS가 설정되어 프론트엔드 접근이 가능하다
4. ✅ 에러 처리 미들웨어가 구현된다
5. ✅ Static 파일 서빙이 구현된다 (프론트엔드)

## Tasks / Subtasks

- [x] Implement Express.js server (AC: 1)
  - [x] Install express ^4.18.0
  - [x] Create server setup in `dashboard/server.js`
  - [x] Configure port 3000 (env var `SERVER_PORT`)
  - [x] Add startup logging

- [x] Implement REST API endpoints (AC: 2)
  - [x] `GET /api/results` - All results
  - [x] `GET /api/results/:date` - Results for specific date
  - [x] `GET /api/results/:date/:slug` - Property detail
  - [x] `GET /api/summary` - All summaries
  - [x] `GET /api/summary/:date` - Summary for date
  - [x] `GET /api/screenshots/:date/:filename` - Screenshot
  - [x] `GET /api/status` - Server status

- [x] Add middleware (AC: 3, 4, 5)
  - [x] CORS middleware with `cors` package
  - [x] JSON body parser
  - [x] Static file serving for `/public`
  - [x] Error handling middleware

## Dev Notes

**Module**: `src/server.js`
**Framework**: Express.js ^4.18.0
**Port**: 3000 (env var `SERVER_PORT`)
**Dependencies**: `express`, `cors`, `ws`

**Current Implementation Status**: ✅ COMPLETED
- File: `src/server.js`
- 8 API endpoints implemented
- CORS configured
- Static file serving active
- Error handling middleware included
- WebSocket integration included (Story 8.2)

**API Endpoints**:
```javascript
GET  /api/results              // All results
GET  /api/results/:date        // Results for date
GET  /api/results/:date/:slug  // Property detail
GET  /api/summary              // All summaries
GET  /api/summary/:date        // Summary for date
GET  /api/screenshots/:date/:filename  // Screenshot
GET  /api/status               // Server status
GET  /api/dates                // Available dates
```

**Integration Points**:
- Reads from: `results/` and `screenshots/` folders
- Serves: Static files from `public/` folder
- WebSocket: Integrated (see Story 8.2)

### Testing

**Manual Testing**: Server running on http://localhost:3000
**API Testing**: Use curl or Postman to test endpoints

**Test Cases**:
- ✅ Server starts successfully
- ✅ All API endpoints return correct data
- ✅ CORS allows frontend access
- ✅ Error handling works for invalid requests
- ✅ Static files served correctly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-29 | 1.0 | Initial story creation from Epic 8 | Sarah (PO) |
| 2025-01-29 | 1.1 | Marked as completed - implementation done | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 3.5 (via Claude Code)

### Completion Notes List

**Initial Implementation (2025-01-29)**:
- Express.js server fully implemented
- 8 REST API endpoints functional
- CORS and middleware configured
- Error handling implemented
- Static file serving active

**QA Fixes Applied (2025-10-29)**:
- ✅ SEC-001: Added rate limiting middleware (100 requests per 15 minutes per IP)
- ✅ SEC-002: Fixed path traversal vulnerability in screenshot endpoint with path.basename() and filename validation
- ✅ SEC-003: Added comprehensive input validation for all parameters (date format, slug format, limit clamping)
- ✅ PERF-001: Optimized file I/O from sequential to parallel using Promise.all() in getResultsForDate()
- ✅ REL-001: Improved error handling with structured responses and full context logging
- ✅ TEST-001: Created comprehensive integration test suite in test/server.test.js covering all 8 endpoints, security measures, error handling, and performance

**Security Enhancements**:
- Rate limiting prevents DoS attacks (express-rate-limit package)
- Path traversal protection prevents unauthorized file access
- Input validation protects against injection attacks and malformed data
- All user inputs sanitized and validated with regex patterns

**Performance Improvements**:
- Parallel file reads reduce latency for multiple result files
- Efficient Promise.all() pattern replaces sequential loops
- Optimized for handling large datasets without blocking

**Reliability Improvements**:
- Structured error responses with error codes for easier debugging
- Full error context logging (message, stack, url, method, timestamp)
- Consistent error handling across all endpoints

### File List

- `src/server.js` - Main server implementation (Express + WebSocket) - **UPDATED with security fixes**
- `test/server.test.js` - Comprehensive integration tests (38 test cases) - **NEW**
- `package.json` - Dependencies (express, cors, ws, express-rate-limit) - **UPDATED**
- `.env` - Configuration (SERVER_PORT=3000)

## QA Results

### Review Date: 2025-10-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment**: Implementation is functionally complete and well-structured, but has critical gaps in security, testing, and error handling that must be addressed before production deployment.

**Strengths**:
- ✅ Clean, readable code with good separation of concerns
- ✅ All 5 acceptance criteria functionally implemented
- ✅ Proper async/await patterns throughout
- ✅ Good documentation and code comments
- ✅ Graceful shutdown handling (SIGTERM)
- ✅ WebSocket integration bonus feature

**Critical Gaps**:
- ❌ No automated tests for any functionality
- ❌ No rate limiting (DoS vulnerability)
- ❌ Path traversal vulnerability in screenshot endpoint
- ❌ No input validation or sanitization
- ⚠️ Synchronous file operations in loops could block under load
- ⚠️ Generic error handling loses debugging context

### Refactoring Performed

**None** - QA Agent did not modify code per advisory role. All improvements listed below are recommendations for Dev team.

### Compliance Check

- **Coding Standards**: ✓ Clean code, good structure, follows Node.js best practices
- **Project Structure**: ✓ Proper file organization in src/ directory
- **Testing Strategy**: ✗ **No automated tests exist** - major gap
- **All ACs Met**: ✓ All 5 ACs functionally implemented

### Requirements Traceability (Given-When-Then)

**AC1**: Express.js server on port 3000
- **Given** environment variable SERVER_PORT=3000
- **When** server starts via `server.listen(PORT)`
- **Then** server binds to port 3000 and serves requests
- **Test Coverage**: Manual only, no automated test

**AC2**: REST API endpoints implemented
- **Given** 8 API endpoints defined (status, dates, results, summary, screenshots)
- **When** HTTP GET requests are made to these endpoints
- **Then** appropriate JSON responses or files are returned
- **Test Coverage**: Manual cURL tests only, no automated integration tests

**AC3**: CORS configured
- **Given** `cors()` middleware enabled (line 71)
- **When** cross-origin requests arrive
- **Then** appropriate CORS headers are sent
- **Test Coverage**: Manual verification only

**AC4**: Error handling middleware
- **Given** error middleware defined (lines 309-315)
- **When** unhandled errors occur in route handlers
- **Then** 500 response with generic error message is sent
- **Test Coverage**: Manual verification only

**AC5**: Static file serving
- **Given** `express.static()` configured for public/ directory (line 73)
- **When** requests are made to static resources
- **Then** files are served from public/ folder
- **Test Coverage**: Manual verification only

### Security Review

**HIGH PRIORITY SECURITY ISSUES**:

1. **SEC-001: No Rate Limiting** (Severity: HIGH)
   - **Issue**: All API endpoints lack rate limiting
   - **Risk**: Vulnerable to DoS attacks, data scraping, brute force
   - **Recommendation**: Install and configure `express-rate-limit`
   ```javascript
   import rateLimit from 'express-rate-limit';

   const apiLimiter = rateLimit({
     windowMs: 15 * 60 * 1000, // 15 minutes
     max: 100, // Limit each IP to 100 requests per windowMs
     message: 'Too many requests, please try again later'
   });

   app.use('/api/', apiLimiter);
   ```

2. **SEC-002: Path Traversal Vulnerability** (Severity: HIGH)
   - **Issue**: Screenshot endpoint (line 293-294) doesn't sanitize filename parameter
   - **Risk**: Attackers could access arbitrary files via `../../etc/passwd`
   - **Recommendation**: Sanitize filename and validate against whitelist
   ```javascript
   // Add validation
   const sanitizedFilename = path.basename(filename); // Remove directory traversal
   if (!/^[\w-]+\.(png|jpg|jpeg)$/.test(sanitizedFilename)) {
     return res.status(400).json({ error: 'Invalid filename' });
   }
   ```

3. **SEC-003: No Input Validation** (Severity: MEDIUM)
   - **Issue**: No validation on query params (limit) or path params (date, slug)
   - **Risk**: Injection attacks, unexpected behavior, crashes
   - **Recommendation**: Use validation middleware (express-validator)

### Performance Considerations

**PERF-001: File I/O Blocking** (Severity: MEDIUM)
- **Issue**: `getResultsForDate()` reads files sequentially in a loop (lines 100-106)
- **Impact**: Blocks event loop when processing many files
- **Recommendation**: Use `Promise.all()` for parallel reads
```javascript
const results = await Promise.all(
  files
    .filter(file => file.endsWith('.json') && file !== '_summary.json')
    .map(async (file) => {
      const content = await fs.readFile(path.join(resultsDir, file), 'utf-8');
      return JSON.parse(content);
    })
);
```

### Reliability Concerns

**REL-001: Generic Error Handling** (Severity: LOW)
- **Issue**: Error middleware (lines 309-315) loses original error context
- **Impact**: Harder to debug production issues
- **Recommendation**: Log full error stack, return structured errors with codes
```javascript
app.use((err, req, res, next) => {
  console.error('Server error:', {
    message: err.message,
    stack: err.stack,
    url: req.url,
    method: req.method
  });

  res.status(err.status || 500).json({
    success: false,
    error: err.message || 'Internal server error',
    code: err.code || 'INTERNAL_ERROR'
  });
});
```

### Test Coverage Analysis

**Current State**: ❌ **Zero automated tests**

**Required Tests** (Priority Order):

1. **P0 - API Integration Tests** (Create `test/server.test.js`):
   - ✗ GET /api/status returns 200 with correct structure
   - ✗ GET /api/dates returns array of date strings
   - ✗ GET /api/results returns paginated results
   - ✗ GET /api/results/:date returns results for date
   - ✗ GET /api/results/:date/:slug returns 404 for invalid slug
   - ✗ GET /api/summary returns summaries array
   - ✗ GET /api/screenshots/:date/:filename returns 404 for missing file
   - ✗ Error handling returns 500 for server errors

2. **P1 - Security Tests**:
   - ✗ Rate limiting blocks excessive requests
   - ✗ Path traversal attempts are blocked
   - ✗ Invalid input parameters are rejected

3. **P2 - Performance Tests**:
   - ✗ API endpoints respond within acceptable time
   - ✗ Server handles concurrent requests

### Improvements Checklist

**Must Fix (Before Production)**:
- [ ] Add rate limiting middleware to all API endpoints (SEC-001)
- [ ] Sanitize filename parameter in screenshot endpoint (SEC-002)
- [ ] Add input validation for all parameters (SEC-003)
- [ ] Create automated integration tests for all endpoints (TEST-001)

**Should Fix (High Priority)**:
- [ ] Optimize file reading with Promise.all() (PERF-001)
- [ ] Improve error handling with structured responses (REL-001)
- [ ] Add request logging middleware (morgan)

**Nice to Have (Future)**:
- [ ] Add API documentation (Swagger/OpenAPI)
- [ ] Add response caching for frequently accessed data
- [ ] Add API versioning (e.g., /api/v1/)
- [ ] Add health check endpoint with detailed diagnostics

### Files Modified During Review

**None** - QA Agent provided advisory review only. No code modifications were made.

### Gate Status

**Gate**: **CONCERNS** → docs/qa/gates/8.1-web-server-rest-api.yml

**Quality Score**: 50/100
- Base: 100
- High severity issues (3): -30 points
- Medium severity issues (2): -20 points
- Final: 50/100

**Risk Profile**: 6 issues identified (3 high, 2 medium, 1 low)

**NFR Assessment**:
- Security: ❌ FAIL (no rate limiting, path traversal vulnerability, no input validation)
- Performance: ⚠️ CONCERNS (blocking file I/O)
- Reliability: ⚠️ CONCERNS (generic error handling)
- Maintainability: ✅ PASS (clean code structure)

### Recommended Status

**✗ Changes Required** - Address critical security issues and add automated tests before production deployment.

**Rationale**: While the implementation is functionally complete and demonstrates good code quality, the lack of security controls (rate limiting, input validation, path traversal protection) and absence of automated tests present unacceptable risks for production deployment.

**Advisory**: This is an **advisory gate**. The team owns the decision to proceed. However, I strongly recommend addressing at minimum the three HIGH severity security issues (SEC-001, SEC-002, SEC-003) before any production release.

---

### Previous QA Notes

✅ All acceptance criteria met (functional implementation)
✅ Server operational on port 3000
✅ API endpoints tested manually and working
✅ CORS verified
✅ Error handling validated (basic middleware exists)
