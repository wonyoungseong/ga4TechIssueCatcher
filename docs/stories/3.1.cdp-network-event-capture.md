# Story 3.1: CDP Network Event Capture

## Status

Done

## Story

**As a** 시스템 개발자,
**I want** Chrome DevTools Protocol을 사용하여 네트워크 요청을 감청하기를 원합니다,
**so that** GA4 이벤트를 캡처하여 검증할 수 있습니다.

## Acceptance Criteria

1. CDP를 활성화하여 네트워크 이벤트를 감청한다
2. `analytics.google.com/g/collect` 패턴의 요청을 필터링한다
3. 캡처된 요청의 URL 파라미터를 파싱하여 측정 ID와 이벤트 정보를 추출한다
4. 페이지 로드 후 최대 10초간 네트워크 이벤트를 대기한다
5. 캡처된 모든 GA4 이벤트를 배열로 저장한다

## Tasks / Subtasks

- [x] Implement CDP network monitoring (AC: 1, 2)
  - [x] Create `networkEventCapturer` module
  - [x] Enable CDP Network domain via `page.context().newCDPSession()`
  - [x] Listen for `Network.requestWillBeSent` events
  - [x] Filter requests matching `analytics.google.com/g/collect` pattern
  - [x] Store captured events in array

- [x] Implement URL parameter parsing (AC: 3)
  - [x] Create `parseGA4Params(url)` function
  - [x] Extract measurement ID from `tid` parameter
  - [x] Extract event name from `en` parameter
  - [x] Extract client ID from `cid` parameter
  - [x] Extract session ID from `sid` parameter
  - [x] Return structured NetworkEvent object

- [x] Implement waiting mechanism (AC: 4)
  - [x] Create `waitForGA4Events(page, timeout)` function
  - [x] Wait for network idle or timeout (default 10s)
  - [x] Use environment variable `NETWORK_TIMEOUT_MS`
  - [x] Return captured events after timeout

- [x] Add comprehensive event capture (AC: 5)
  - [x] Capture all matching requests during page session
  - [x] Include request headers and timestamps
  - [x] Handle multiple GA4 events per page
  - [x] Return complete event array

## Dev Notes

**Module**: `networkEventCapturer`
**CDP Domain**: Network
**Filter Pattern**: `https://analytics.google.com/g/collect*`
**Timeout**: Environment variable `NETWORK_TIMEOUT_MS` (default: 10000ms)

**CDP Setup**:
```javascript
async function startCapturing(page) {
  const client = await page.context().newCDPSession(page);
  await client.send('Network.enable');

  const capturedEvents = [];

  client.on('Network.requestWillBeSent', (params) => {
    if (params.request.url.includes('analytics.google.com/g/collect')) {
      capturedEvents.push({
        url: params.request.url,
        method: params.request.method,
        headers: params.request.headers,
        timestamp: params.timestamp
      });
    }
  });

  return capturedEvents;
}
```

**URL Parameter Parsing**:
```javascript
function parseGA4Params(url) {
  const urlObj = new URL(url);
  const params = {};

  // Extract measurement ID (tid parameter)
  params.measurementId = urlObj.searchParams.get('tid'); // G-XXXXXXXXX

  // Extract event name (en parameter)
  params.eventName = urlObj.searchParams.get('en'); // e.g., 'page_view'

  // Extract other GA4 parameters
  params.clientId = urlObj.searchParams.get('cid');
  params.sessionId = urlObj.searchParams.get('sid');

  return params;
}
```

**Integration Points**:
- Called by: `orchestrator` during property validation
- Input: Playwright page object
- Output: Array of NetworkEvent objects
- Used by: `configValidator` for GA4/GTM validation

### Testing

**Test Framework**: Jest (when implemented)
**Test Location**: `test/modules/networkEventCapturer.test.js`

**Testing Standards**:
- Unit tests for CDP network capture
- Integration tests with real pages
- Test cases:
  - Capture GA4 events from page
  - Filter non-GA4 requests correctly
  - Parse measurement ID from URL
  - Parse event name from URL
  - Handle multiple GA4 events
  - Timeout after 10 seconds
  - Handle pages with no GA4 events

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-29 | 1.0 | Initial story creation from Epic 3 | Sarah (PO) |
| 2025-01-29 | 1.1 | Story approved and ready for development | Sarah (PO) |
| 2025-01-29 | 1.2 | Tests created and all tasks completed (22/22 tests passing). Module was already implemented. | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No errors encountered during development. All tests pass successfully.

### Completion Notes List

1. **Module Already Implemented** (AC1-5):
   - `networkEventCapturer.js` was already fully implemented with all required functionality
   - Includes CDP network monitoring, URL parameter parsing, waiting mechanism, and event capture
   - Module includes advanced features like GTM AP_DATA parsing

2. **Comprehensive Test Suite Created**:
   - Created `test/modules/networkEventCapturer.test.js` with 22 test cases
   - Test coverage includes:
     - URL parameter parsing (GA4 measurement ID, event name, client ID, session ID)
     - AP_DATA parsing (GTM parameters, hierarchical data)
     - Event summary generation
     - Integration tests with real browser pages
     - Stealth mode validation (User-Agent, platform, webdriver property)

3. **Test Results**:
   - All 22 networkEventCapturer tests passing
   - Total project tests: 124/124 passing
   - Test duration: ~44.5 seconds for full suite

4. **Test Bug Fix**:
   - Fixed integration test setup to properly use `getBrowser(0)` with index parameter
   - Browser pool cleanup simplified to use `browserPool.cleanup()` directly

### File List

**Created Files**:
- `test/modules/networkEventCapturer.test.js` - Comprehensive test suite (22 test cases)

**Existing Files** (Already Implemented):
- `src/modules/networkEventCapturer.js` - CDP network event capture module (275 lines)

## QA Results

(To be filled by QA agent)
