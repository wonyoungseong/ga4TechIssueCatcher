# Story 3.3: GTM Container ID Validation

## Status

Done

## Story

**As a** 디지털 애널리틱스 팀원,
**I want** 페이지의 GTM 스크립트에서 컨테이너 ID를 추출하여 CSV 기대값과 비교하기를 원합니다,
**so that** 올바른 GTM 컨테이너가 로드되는지 확인할 수 있습니다.

## Acceptance Criteria

1. 페이지 HTML에서 GTM 스크립트 태그를 검색한다
2. GTM 컨테이너 ID(GTM-XXXXXXXX)를 정규식으로 추출한다
3. CSV 파일의 기대 GTM ID와 일치 여부를 확인한다
4. GTM ID 불일치 시 이슈로 기록한다
5. GTM 스크립트가 전혀 없으면 "GTM 없음" 이슈로 기록한다
6. 검증 결과(일치/불일치)를 JSON 결과에 저장한다

## Tasks / Subtasks

- [x] Implement GTM detection (AC: 1, 2)
  - [x] Create `validateGTMIdFromHTML()` function in `configValidator` module
  - [x] Get page HTML content using `page.content()`
  - [x] Search for GTM script tags using regex
  - [x] Use pattern `GTM-[A-Z0-9]{6,}`
  - [x] Extract GTM container ID

- [x] Implement comparison logic (AC: 3, 4, 5)
  - [x] Compare extracted GTM ID with expected ID from CSV
  - [x] Handle case: No GTM script found
  - [x] Handle case: GTM ID mismatch
  - [x] Generate IssueReport for each case
  - [x] Set severity to 'critical'

- [x] Create validation result structure (AC: 6)
  - [x] Return ValidationResult object
  - [x] Include `isValid` boolean
  - [x] Include `actualId` (detected GTM ID)
  - [x] Include `issues` array

## Dev Notes

**Module**: `configValidator`
**Function**: `validateGTMId(page, expectedGtmId)`
**Regex Pattern**: `GTM-[A-Z0-9]{6,}`

**GTM Detection Logic**:
```javascript
async function validateGTMId(page, expectedGtmId) {
  const issues = [];

  // Get page HTML content
  const htmlContent = await page.content();

  // Search for GTM script tags
  const gtmPattern = /GTM-[A-Z0-9]{6,}/g;
  const matches = htmlContent.match(gtmPattern);

  if (!matches || matches.length === 0) {
    issues.push({
      type: 'GTM_NOT_FOUND',
      severity: 'critical',
      message: 'No GTM script detected on page',
      expected: expectedGtmId,
      actual: null,
      timestamp: new Date().toISOString()
    });
    return { isValid: false, actualId: null, issues };
  }

  // Check if expected GTM ID is present
  const actualId = matches[0];
  if (actualId !== expectedGtmId) {
    issues.push({
      type: 'GTM_ID_MISMATCH',
      severity: 'critical',
      message: `GTM container ID mismatch`,
      expected: expectedGtmId,
      actual: actualId,
      timestamp: new Date().toISOString()
    });
    return { isValid: false, actualId, issues };
  }

  return { isValid: true, actualId, issues: [] };
}
```

**Issue Types**:
- `GTM_NOT_FOUND`: No GTM script on page
- `GTM_ID_MISMATCH`: Wrong GTM container ID

**Integration Points**:
- Input: Playwright page object, expectedGtmId from CSV
- Output: ValidationResult with issues
- Called by: `orchestrator` during property validation

### Testing

**Test Framework**: Jest (when implemented)
**Test Location**: `test/modules/configValidator.test.js`

**Testing Standards**:
- Unit tests for GTM validation
- Test cases:
  - Valid GTM ID matches expected
  - GTM ID mismatch detected
  - No GTM script found
  - Multiple GTM IDs on page (edge case)
  - Invalid GTM ID format
  - Empty expected GTM ID

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-29 | 1.0 | Initial story creation from Epic 3 | Sarah (PO) |
| 2025-01-29 | 1.1 | Story approved and ready for development | Sarah (PO) |
| 2025-10-29 | 1.2 | Implemented HTML-based GTM validation with comprehensive tests | James (Dev) |
| 2025-10-29 | 1.3 | QA review complete - PASS gate, all ACs validated, status updated to Ready for Done | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Implementation Summary
Implemented HTML-based GTM container ID validation as specified in story requirements. Created `validateGTMIdFromHTML()` function that scans page HTML content using regex pattern to extract and validate GTM IDs against expected values from CSV.

### Completion Notes

**Implementation Approach:**
- Added `validateGTMIdFromHTML()` function to `configValidator` module as HTML-based alternative to existing network-event validation
- Function uses `page.content()` to get HTML and regex pattern `/GTM-[A-Z0-9]{6,}/g` to extract GTM IDs
- Implements all acceptance criteria: HTML search, regex extraction, comparison logic, issue reporting, result structure
- Returns structured validation result with `isValid`, `actualId`, and `issues` array

**Key Decisions:**
- Implemented as additional validation method alongside existing network-based validation (preserves existing functionality)
- Added `GTM_NOT_FOUND` to ISSUE_TYPE constants for new issue type
- Function signature follows story specification: `validateGTMIdFromHTML(page, expectedGtmId)`
- Uses first GTM ID match when multiple IDs present in HTML

**Test Coverage:**
- Created comprehensive test suite with 20 test cases
- All acceptance criteria covered (AC1-AC6)
- Edge cases tested: multiple GTM IDs, empty HTML, noscript tags, invalid formats, special characters
- Test framework: Node.js native test framework (node:test)
- All tests passing: 20/20 ✅

**Integration:**
- Function exported in configValidator module default export
- Available for use by orchestrator or as fallback validation method
- Compatible with existing validation workflow

### Debug Log References
- Test execution: `npm test -- test/modules/configValidator.test.js`
- All 20 tests passed successfully
- Test execution time: ~5ms

### File List

**Modified Files:**
- `src/modules/configValidator.js` - Added `validateGTMIdFromHTML()` function and `GTM_NOT_FOUND` issue type

**New Files:**
- `test/modules/configValidator.test.js` - Comprehensive test suite with 20 test cases covering all ACs and edge cases

## QA Results

### Review Information
- **Reviewer**: Quinn (QA Agent)
- **Review Date**: 2025-10-29
- **Quality Gate**: ✅ **PASS**
- **Production Ready**: Yes
- **Gate File**: `docs/qa/gates/3.3-gtm-container-id-validation.yml`

### Summary
Story 3.3 implementation successfully meets all acceptance criteria with comprehensive test coverage. The `validateGTMIdFromHTML()` function provides reliable HTML-based GTM validation with excellent code quality and low risk across all NFR dimensions.

### Requirements Coverage
- **Total Acceptance Criteria**: 6
- **Covered**: 6 (100%)
- **Test Cases**: 20 (all passing)
- **Test Pass Rate**: 100%
- **Execution Time**: ~5ms

### AC Traceability
| AC | Description | Implementation | Tests | Status |
|----|-------------|----------------|-------|--------|
| AC1 | Search GTM script tags in HTML | `configValidator.js:76-80` | Lines 28-79 | ✅ PASS |
| AC2 | Extract GTM ID using regex | `configValidator.js:76-80` | Lines 28-79 | ✅ PASS |
| AC3 | Compare with expected GTM ID | `configValidator.js:96-108` | Lines 82-111 | ✅ PASS |
| AC4 | Record GTM ID mismatch issues | `configValidator.js:99-108` | Lines 114-146 | ✅ PASS |
| AC5 | Record GTM not found issues | `configValidator.js:83-92` | Lines 149-180 | ✅ PASS |
| AC6 | Store results in JSON format | `configValidator.js:92,108,112` | Lines 276-309 | ✅ PASS |

### Non-Functional Requirements
**Security**: ✅ PASS (Risk: LOW)
- No user input concatenation in regex
- Secure Playwright API usage
- No dynamic code execution
- Safe timestamp generation

**Performance**: ✅ PASS (Risk: LOW)
- O(n) complexity with simple regex
- Early return optimization
- Estimated execution: <10ms
- First match strategy efficient

**Reliability**: ✅ PASS (Risk: LOW)
- 100% test pass rate (20/20)
- Comprehensive error handling
- Mock-based test isolation
- Deterministic results
- Edge cases covered

**Maintainability**: ✅ PASS (Risk: LOW)
- Clear JSDoc documentation
- AC mapping in comments
- Consistent naming conventions
- Single responsibility
- Low cognitive complexity (cyclomatic: 3)
- Well-organized test structure

### Code Quality Assessment
**Strengths**:
- Clear async/await pattern with proper error handling
- Structured issue objects with consistent format
- AC comments provide excellent traceability
- Early exit pattern for performance
- Comprehensive test coverage with 6 edge cases
- Test names clearly describe expected behavior

**Observations**:
- Function uses first match strategy when multiple GTM IDs present (documented and tested)
- Full HTML content load used (acceptable for typical pages)
- No HTML sanitization (read-only operation, low risk)

### Integration Assessment
- **Module Exports**: ✅ Verified (`validateGTMIdFromHTML`, `ISSUE_TYPE.GTM_NOT_FOUND`)
- **Existing Functionality**: ✅ Preserved (no breaking changes)
- **Orchestrator Compatibility**: ✅ Compatible (can use as fallback validation)
- **Network Capturer Relationship**: ✅ Complements existing network-based validation

### Risk Assessment
- **Identified Risks**: None
- **Mitigated Risks**:
  - Large HTML pages → Early return pattern and simple regex reduce impact (residual: LOW)
  - Multiple GTM IDs → First match strategy documented and tested (residual: LOW)
  - Regex pattern coverage → Tested with various formats and edge cases (residual: LOW)

### Recommendations
**Immediate Actions**: None required

**Future Enhancements** (Low Priority):
1. Consider HTML sanitization for defense-in-depth (current read-only operation is safe)
2. Add performance monitoring for large HTML pages in production
3. Consider logging all GTM IDs when multiple present (helps debugging)

### Final Decision
**Gate Status**: ✅ **PASS**
- All acceptance criteria implemented correctly
- 100% test coverage with comprehensive edge cases
- Low risk across all NFR dimensions
- Excellent code quality and maintainability
- Production ready with no blocking issues

**Approval**: Quinn (QA Agent) - 2025-10-29
